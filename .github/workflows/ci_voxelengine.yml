name: VoxelEngine CI

# Temporarily only apply to CI branch for testing. This should be replaced with 
# on:
#   push:
#     branches: ['**']
#   pull-request:
#     branches: [master]
on:
  push:
    branches: [ci]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v2
    - name: Configure
      run: |
        choco install ninja cmake python visualstudio2019buildtools -y --no-progress
        choco install visualstudio2022buildtools --version 117.1.2.0 -y --no-progress
        choco install llvm --version 14.0.0 -y --no-progress
        pip install conan --progress-bar off
        mkdir out
    - name: Run CMake
      working-directory: ./out
      run: |
        python ../.github/workflows/run_cmake.py
    - name: Build
      working-directory: ./out
      run: |
        cmake --build ./debug --target all
    - name: Engine test run
      working-directory: ./out/debug/bin
      run: VELauncher --client --server --run_for=100
    - name: Run unit tests
      working-directory: ./out/debug
      run: ctest --extra-verbose
